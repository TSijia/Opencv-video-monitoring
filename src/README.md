
# 基于OPENCV的视频监控


## 程序框架
### 线程管理
线程管理以Controller类和Worker类为基础，Controller线程先创建，然后不断读取解析用户指令，根据要求创建多个Worker线程

**1.Controller和多个Worker之间的通信**

   他们之间通信是通过两个全局的参数表

- **线程参数表(在没有更改时使用默认参数值)**
  
    | thread  | threadID | threadOP | CameraLabel |  filePath  | edgeNUM | method |
    |---------|----------|----------|-------------|------------|---------|--------|
    | worker0 |     0    |   none   |      -1     | luren1.avi |    4    |   knn  |
    | worker1 |     0    |   none   |      -1     | luren1.avi |    4    |   knn  |
    | worker2 |     0    |   none   |      -1     | luren1.avi |    4    |   knn  |
    | worker3 |     0    |   none   |      -1     | luren1.avi |    4    |   knn  |
    | worker4 |     0    |   none   |      -1     | luren1.avi |    4    |   knn  |
    | worker5 |     0    |   none   |      -1     | luren1.avi |    4    |   knn  |

-  **线程状态表**

    | thread  | threadState |
    |---------|-------------|
    | worker0 |      0      |  
    | worker1 |      0      |  
    | worker2 |      0      |  
    | worker3 |      0      |   
    | worker4 |      0      |   
    | worker5 |      0      |   

当线程X没有创建时，threadState为0，线程X创建后该threadSate为1（已创建），当线程X的threadSate为1，并有从命令行读取到线程X的ID时，将threadSate置为2（要修改参数），当该线程参数修改完成并且没有退出线程X的指令时，threadSate重新置为1，关闭线程前将threadSate置为0

**2.Controller类**

在Controller类的controltask()函数，在死循环中不断调用getline(...)函数读取命令行参数，并调用boost库的split(...)函数将读取的字符串进行解析，以空格为截断点保存在一个string类型的vector中：

- 首先如果用户输入“quit”则退出进程
- 接下来遍历看是否有“threadID”，如果没有则提示重新输入，等待输入；如果有，则将他的下一个元素保存到公共的参数表中对应的线程ID的参数处
- 遍历输入的字符串，每一个字符串都和对应的线程参数表的键值（表头）做比较，若相等，则将下一位的值赋给线程参数表中对应键值的值，更新公共的线程参数表对应的行
- 根据更新的数据进行线程的创建、关闭、参数修改

**3.Worker类**

在Worker的detect_function()函数中根据公共参数表中的参数进行程序的设置：

- 使用摄像头还是本地视频的处理
- 每读取一帧，先判断：是否捕获到异常（线程关闭指令）；是否要更新参数
- 对视频进行移动物体的检测，并获得矩形框
- 矩形框与布放区域的入侵检测，并将符合条件的入侵情况保存在当前目录下的dangerVideo/文件夹下，每个线程会以自己的线程ID为文件夹名在这个文件夹下新建子文件夹

### 布防区域入侵检测

**1.PersonDetection类** 

 - 输入：视频的每一帧frame，用户选定的method；输出：检测出的移动物体的矩形框personrect。
 - 任务1：根据用户的method输入来确定生成相应的背景分离模型对象。
 - 任务2：根据背景分离的结果得到移动物体的矩形框personrect并返回。
 - 在该过程中进行了腐蚀和膨胀操作
 
**2.IntrusionDetection类:**

- 该类需要视频的每一帧frame（设置为引用&frame），矩形框personrect和一个需要检测危险区域。
- 任务是判断矩形框personrect与一个危险区域是否相交，如果相交，则会在视频帧（&frame引用）上画出相交的区域，并得到相交区域的点坐标信息。
- "真正危险入侵标准" 
  - 相交区域面积大于一个布防区域的%15（以后会设计成用户可改的，可能不是具体的数字，可能会等同于敏感程度）
  - 当某一帧满足入侵之后，会连续存3（以后设计成可改）帧的结果，如果这连续三帧都是入侵结果，报警(没有加上，因为这样命令行输出太多，会修改)，并从下一帧开始保存
  - 当遇到开始保存后的第一帧结果为没有入侵时停止保存
  - 重复2、3
  
## 问题
 - 背景分割算法，knn整体效果不错，但还是有很大局限性，还是需要尝试其他更好的算法
 - 资源管理，在创建一个线程后关闭，再使用该线程ID创建线程后，opencv的nameWindow不显示
 - 报警和保存视频的逻辑还需要进一步改进，觉得接下来保存的视频有的帧很短比较乱
 - 程序结构优化